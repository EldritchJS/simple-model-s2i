cp -R /tmp/src/* /opt/sms/

export S2I_SOURCE_NOTEBOOK=${S2I_SOURCE_NOTEBOOK:-model.ipynb}
export S2I_SOURCE_NOTEBOOK_PATH=${S2I_SOURCE_NOTEBOOK_PATH:-/opt/sms/${S2I_SOURCE_NOTEBOOK}}
export S2I_MODEL_FILE=${S2I_MODEL_FILE:-model.pickle}
export S2I_MODEL_PATH=${S2I_MODEL_PATH:-/opt/sms/${S2I_MODEL_FILE}}

cd /opt/sms

python3 ./extract-requirements.py ${S2I_SOURCE_NOTEBOOK} reqs-${S2I_SOURCE_NOTEBOOK}
python3 ./append.py ${S2I_SOURCE_NOTEBOOK} patched-${S2I_SOURCE_NOTEBOOK}

python3 $(which jupyter) nbconvert --to script patched-${S2I_SOURCE_NOTEBOOK} 
python3 $(which jupyter) nbconvert --to script reqs-${S2I_SOURCE_NOTEBOOK} 

python3 ./$(basename reqs-${S2I_SOURCE_NOTEBOOK} .ipynb).py

echo \n\nEXTRA REQUIREMENTS ARE:
cat extra-requirements.txt

echo

virtualenv-3 app 
source app/bin/activate 

app/bin/pip install "cloudpickle == 0.5.3" "flask"

if (( $(wc -l < extra-requirements.txt) > 0 )); then
    echo "\n\nINSTALLING EXTRA REQUIREMENTS"
    app/bin/pip install -r extra-requirements.txt
fi

if [[ x$S2I_SPACY_MODEL != "x" ]] ; then
    echo "\n\nINSTALLING SPACY MODEL $S2I_SPACY_MODEL"
    app/bin/python -m spacy download $S2I_SPACY_MODEL
fi

echo "\n\nGENERATING MODEL"
app/bin/python ./$(basename patched-${S2I_SOURCE_NOTEBOOK} .ipynb).py

